<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Projex</title>
    <style>
      body { margin: 0; }
      
      #model-picker {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        font-size: 1.1rem;
        background: rgba(0,0,0,0.5);
        color: white;
        border-radius: 5px;
        padding: 20px;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .tabs {
        display: flex;
        border-bottom: 2px solid #666;
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1.5rem;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .tab:hover {
        background: rgba(255,255,255,0.1);
      }

      .tab.active {
        border-bottom-color: white;
        background: rgba(255,255,255,0.1);
      }

      .tab-content {
        display: none;
        overflow-y: auto;
        max-height: 60vh;
      }

      .tab-content.active {
        display: block;
      }

      .subcategory {
        margin-bottom: 20px;
      }

      .subcategory h3 {
        margin: 0 0 10px 0;
        color: white;
        font-size: 1.5rem;
        border-bottom: 1px solid #666;
        padding-bottom: 5px;
      }

      .model-grid {
        display: flex;
        flex-direction: column;
        gap: 0;
        margin-bottom: 15px;
        align-items: center;
      }

      .model-button {
        padding: 2px 2px;
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1.2rem;
        text-align: center;
        margin: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        width: 100%;
        padding: 8px 2px;
      }

      .model-button:last-child {
        border-bottom: none;
      }

      .model-button:hover {
        background: rgba(255,255,255,0.1);
      }

      a, a:visited, a:active, a:hover {
        color: white;
        text-decoration: underline;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: white;
      }

      .error {
        color: #ff6b6b;
        text-align: center;
        padding: 20px;
      }

      #ai-settings {
        position: absolute;
        bottom: 10px;
        left: 10px;
        padding: 12px 16px;
        background: rgba(0,0,0,0.5);
        color: white;
        border-radius: 5px;
        width: 280px;
        font-size: 0.95rem;
      }

      #ai-settings h3 {
        margin: 0 0 10px 0;
        font-size: 1.1rem;
        border-bottom: 1px solid rgba(255,255,255,0.3);
        padding-bottom: 6px;
      }

      #ai-settings label {
        display: block;
        margin: 8px 0;
        cursor: pointer;
      }

      #ai-settings input[type="checkbox"],
      #ai-settings input[type="radio"] {
        margin-right: 8px;
        cursor: pointer;
      }

      #ai-settings .color-options {
        margin-left: 20px;
        margin-top: 6px;
      }

      #ai-settings .slider-container {
        margin-top: 12px;
      }

      #ai-settings input[type="range"] {
        width: 100%;
        margin-top: 6px;
      }

      #ai-settings .slider-value {
        text-align: center;
        font-size: 0.9rem;
        color: rgba(255,255,255,0.8);
      }

      #ai-settings .disabled {
        opacity: 0.5;
        pointer-events: none;
      }
    </style>
    <script type="module" crossorigin src="./assets/index-DuLHqKrh.js"></script>
    <script src="./assets/ai-enhanced.js" defer></script>
  </head>
  <body>
    
    <div id="model-picker">
      <div class="loading">Loading models...</div>
    </div>

    <div id="loading-bar" style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      font-size: 2rem;
      color: white;
      background: rgba(0,0,0,1);
      border-radius: 5px;
      padding: 10px 20px;
      display: none;
      ">
      Loading
    </div>

    <div id="intro" style="
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.5);
      color: white;
      border-radius: 5px;
      width: 300px;
      ">
      It's projective hex! Invented by Bill Taylor. <br>
      Most models generated by <a href = https://levskaya.github.io/polyhedronisme> polyHÃ©dronisme</a>. <br>
      <br>
  
      Mouse drag or Shift + Arrows : Rotate <br>
      R : Red's turn <br>
      B : Blue's turn <br>
      Shift + Click : Reset tile <br>
      Shift + Z : Undo last move <br>
      Shift + Q : Randomize board <br> 
      Shift + W : Reset board <br>
      <br>
      This polyhedron represents a tiling of RP2;
      opposite faces are identified.
      You win if your color contains a non-contractible loop. 
      <br>
      <br>
      <a href="rules.html"> More Info </a> <br>
    </div>

    <div id="win-popup" style="
      position: fixed;
      top: 50%;
      left: 15%;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.85);
      color: white;
      padding: 24px 36px;
      border-radius: 12px;
      font-size: 1.5rem;
      text-align: center;
      display: none;
      z-index: 500;
      ">
    wins! 
    </div>
    
    <div id="error-popup" style="
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.85);
      color: white;
      padding: 24px 36px;
      border-radius: 12px;
      font-size: 1.5rem;
      text-align: center;
      display: none;
      z-index: 500;
      ">
    Invalid model! 
    </div>
    
    <div id="turn-popup" style="
      position: fixed;
      top: 50%;
      left: 85%;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.85);
      color: white;
      padding: 24px 36px;
      border-radius: 12px;
      font-size: 1.5rem;
      text-align: center;
      display: none;
      z-index: 999;
      ">
    turn 
    </div>

    <div id="ai-settings">
      <h3>AI Opponent</h3>
      <label>
        <input type="checkbox" id="ai-toggle"> Play vs AI
      </label>
      <div id="ai-options" class="disabled">
        <div class="color-options">
          <label>
            <input type="radio" name="player-color" value="red" checked> Play as Red
          </label>
          <label>
            <input type="radio" name="player-color" value="blue"> Play as Blue
          </label>
        </div>
        <div class="slider-container">
          <label>AI Strength (MCTS iterations):</label>
          <input type="range" id="mcts-slider" min="0" max="100" value="50" step="1">
          <div class="slider-value" id="mcts-value">1000 iterations</div>
        </div>
        <div style="margin-top: 12px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px;">
          <label style="font-weight: bold;">AI Type:</label>
          <label>
            <input type="radio" name="ai-type" value="basic" checked> Basic MCTS
          </label>
          <label>
            <input type="radio" name="ai-type" value="enhanced"> Enhanced (Heuristic)
          </label>
        </div>
        <div style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px;">
          <label>
            <input type="checkbox" id="show-current-flow"> Show current flow
          </label>
          <div id="flow-legend" style="display: none; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 4px;">
            Brighter = higher current (bottleneck)
          </div>
        </div>
      </div>
    </div>

    <div id="ai-test-panel" style="
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 12px 16px;
      background: rgba(0,0,0,0.5);
      color: white;
      border-radius: 5px;
      width: 300px;
      font-size: 0.9rem;
    ">
      <h3 style="margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 6px;">AI vs AI Test (Time-Matched)</h3>
      <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 8px;">Both AIs get equal time per move</div>
      <div style="margin-bottom: 10px;">
        <label>Number of games:</label>
        <input type="number" id="test-games" value="10" min="1" max="100" style="width: 60px; margin-left: 8px;">
      </div>
      <button id="run-test-btn" style="
        padding: 8px 16px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.95rem;
      ">Run Test</button>
      <div id="test-progress" style="margin-top: 10px; display: none;">
        <div style="background: rgba(255,255,255,0.2); border-radius: 4px; height: 20px; overflow: hidden;">
          <div id="progress-bar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.2s;"></div>
        </div>
        <div id="progress-text" style="text-align: center; margin-top: 4px; font-size: 0.85rem;"></div>
      </div>
      <div id="test-results" style="margin-top: 10px; font-size: 0.85rem;"></div>
    </div>

    <script>
      // Load and display the model picker
      async function loadModelPicker() {
        try {
          const response = await fetch('./models.json');
          const data = await response.json();
          
          const picker = document.getElementById('model-picker');
          picker.innerHTML = '';
          
          // Create tabs
          const tabsContainer = document.createElement('div');
          tabsContainer.className = 'tabs';
          
          const tabContents = document.createElement('div');
          tabContents.className = 'tab-contents';
          
          data.categories.forEach((category, index) => {
            // Create tab button
            const tab = document.createElement('button');
            tab.className = `tab ${index === 0 ? 'active' : ''}`;
            tab.textContent = category.name;
            tab.onclick = () => switchTab(index);
            tabsContainer.appendChild(tab);
            
            // Create tab content
            const content = document.createElement('div');
            content.className = `tab-content ${index === 0 ? 'active' : ''}`;
            
            // Group models by subcategory
            const categoryModels = data.models.filter(model => model.category === category.id);
            const subcategories = {};
            
            categoryModels.forEach(model => {
              if (!subcategories[model.subcategory]) {
                subcategories[model.subcategory] = [];
              }
              subcategories[model.subcategory].push(model);
            });
            
            // Create subcategory sections
            Object.entries(subcategories).forEach(([subcategoryName, models]) => {
              const subcategory = document.createElement('div');
              subcategory.className = 'subcategory';
              
              const subcategoryTitle = document.createElement('h3');
              subcategoryTitle.textContent = subcategoryName;
              subcategory.appendChild(subcategoryTitle);
              
              const modelGrid = document.createElement('div');
              modelGrid.className = 'model-grid';
              
              models.forEach(model => {
                const button = document.createElement('button');
                button.className = 'model-button';
                button.setAttribute('data-model', model.file);
                button.setAttribute('data-gamemode', model.gameMode);
                if (model.atoll) {
                  button.setAttribute('data-atoll', model.atoll);
                }
                
                const buttonText = document.createElement('div');
                buttonText.textContent = model.name;
                button.appendChild(buttonText);
                
                modelGrid.appendChild(button);
              });
              
              subcategory.appendChild(modelGrid);
              content.appendChild(subcategory);
            });
            
            tabContents.appendChild(content);
          });
          
          picker.appendChild(tabsContainer);
          picker.appendChild(tabContents);
          
          
        } catch (error) {
          console.error('Error loading models:', error);
          document.getElementById('model-picker').innerHTML = 
            '<div class="error">Error loading models. Please check the console for details.</div>';
        }
      }
      
      function switchTab(index) {
        // Remove active class from all tabs and contents
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active class to selected tab and content
        document.querySelectorAll('.tab')[index].classList.add('active');
        document.querySelectorAll('.tab-content')[index].classList.add('active');
      }
      
      // Load the model picker when the page loads
      document.addEventListener('DOMContentLoaded', loadModelPicker);

      // AI Settings wiring
      document.addEventListener('DOMContentLoaded', function() {
        const aiToggle = document.getElementById('ai-toggle');
        const aiOptions = document.getElementById('ai-options');
        const mctsSlider = document.getElementById('mcts-slider');
        const mctsValue = document.getElementById('mcts-value');
        const colorRadios = document.querySelectorAll('input[name="player-color"]');

        aiToggle.addEventListener('change', function() {
          const enabled = this.checked;
          if (enabled) {
            aiOptions.classList.remove('disabled');
          } else {
            aiOptions.classList.add('disabled');
          }
          if (window.setAIEnabled) {
            window.setAIEnabled(enabled);
          }
        });

        colorRadios.forEach(radio => {
          radio.addEventListener('change', function() {
            if (window.setHumanColor) {
              window.setHumanColor(this.value);
            }
          });
        });

        mctsSlider.addEventListener('input', function() {
          // Log scale: 0-100 slider maps to 50-1000000 iterations
          const minIter = 50, maxIter = 1000000;
          const minLog = Math.log(minIter), maxLog = Math.log(maxIter);
          const scale = (maxLog - minLog) / 100;
          const iterations = Math.round(Math.exp(minLog + scale * this.value));
          mctsValue.textContent = iterations.toLocaleString() + ' iterations';
          if (window.setMctsIterations) {
            window.setMctsIterations(iterations);
          }
        });
        // Initialize with default value
        mctsSlider.dispatchEvent(new Event('input'));

        // AI Type selection
        const aiTypeRadios = document.querySelectorAll('input[name="ai-type"]');
        aiTypeRadios.forEach(radio => {
          radio.addEventListener('change', function() {
            if (window.setEnhancedAI) {
              window.setEnhancedAI(this.value === 'enhanced');
            }
          });
        });

        // Current flow visualization toggle
        const showFlowCheckbox = document.getElementById('show-current-flow');
        const flowLegend = document.getElementById('flow-legend');
        
        showFlowCheckbox.addEventListener('change', function() {
          flowLegend.style.display = this.checked ? 'block' : 'none';
          if (window.setShowCurrentFlow) {
            window.setShowCurrentFlow(this.checked);
          }
          if (this.checked && window.updateCurrentFlowVisualization) {
            window.updateCurrentFlowVisualization();
          }
        });

        // Test button
        const runTestBtn = document.getElementById('run-test-btn');
        const testGamesInput = document.getElementById('test-games');
        const testProgress = document.getElementById('test-progress');
        const testResults = document.getElementById('test-results');

        runTestBtn.addEventListener('click', function() {
          if (!window.testAIs) {
            testResults.innerHTML = '<span style="color: #ff6b6b;">Please load a model first</span>';
            return;
          }

          const numGames = parseInt(testGamesInput.value) || 10;
          runTestBtn.disabled = true;
          runTestBtn.textContent = 'Running...';
          testProgress.style.display = 'block';
          testResults.innerHTML = '';
          
          // Reset progress bar
          const progressBar = document.getElementById('progress-bar');
          const progressText = document.getElementById('progress-text');
          progressBar.style.width = '0%';
          progressText.textContent = 'Starting...';

          // Ensure even number of games for fair Red/Blue distribution
          const actualGames = numGames % 2 === 0 ? numGames : numGames + 1;

          window.testAIs(actualGames, function(update) {
            if (update.done) {
              runTestBtn.disabled = false;
              runTestBtn.textContent = 'Run Test';
              progressBar.style.width = '100%';
              progressBar.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
              progressText.textContent = 'Complete!';
              
              const r = update.results;
              testResults.innerHTML = `
                <div style="margin-bottom: 6px;"><strong>Results (${actualGames} games, ${r.timePerMoveMs}ms/move):</strong></div>
                <div>Basic AI wins: ${r.basicWins} (${r.basicWinRate})</div>
                <div>Enhanced AI wins: ${r.enhancedWins} (${r.enhancedWinRate})</div>
                <div>Draws: ${r.draws}</div>
                <div style="margin-top: 6px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 6px;">
                  <div>Avg moves/game: ${r.avgMoves.toFixed(1)}</div>
                  <div>Basic: ${r.avgBasicIter} iter/move avg</div>
                  <div>Enhanced: ${r.avgEnhancedIter} iter/move avg</div>
                </div>
              `;
            } else {
              const pct = (update.progress / update.total * 100).toFixed(0);
              progressBar.style.width = pct + '%';
              progressText.textContent = `Game ${update.progress} / ${update.total}`;
              
              // Show current standings
              const r = update.results;
              if (r.basicWins + r.enhancedWins > 0) {
                progressText.textContent += ` (Basic: ${r.basicWins}, Enhanced: ${r.enhancedWins})`;
              }
            }
          });
        });
      });
    </script>

</html>